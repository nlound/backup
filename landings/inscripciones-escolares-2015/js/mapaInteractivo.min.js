function loadMap(){var a="http://gcba.cartodb.com/api/v2/viz/7300df2c-c41c-11e4-8286-0e853d047bba/viz.json";cartodb.createVis("mapaInteractivo",a).done(function(a,b){capas=a.map,capaInfowindows=b[1];var c=b[1].getSubLayer(0);sublayers.push(c),c.infowindow.set("template",$("#infowindow_template").html())})}function toggleFiltros(){var a=$("#filtro1 a")[0],b=$("#filtro2 li"),c=[];$("#filtro2 li").hide(),a=$(a).text().trim();for(var d=0;d<$("#filtro1 li").length;d++){var e=$("#filtro1 li")[d];$(e).text().trim()==a&&(c=$(e).attr("class"))}c=c.split(" ");for(var d=0;d<$(b).length;d++)for(var f=0;f<c.length;f++)$(b[d]).hasClass(c[f])&&$(b[d]).show();$(b[0]).show()}function filtro(a){$(".close")[0].click();var b="SELECT * FROM escuelas_2015",c=!1;"Ver todos"!==$("#filtro1 a")[0].text.trim()&&(b=b+" WHERE nivel LIKE '"+$("#filtro1 a")[0].text.trim()+"'",c=!0),"Ver todas"!==$("#filtro2 a")[0].text.trim()&&(b+=c?" AND":" WHERE",b=b+" modalidad LIKE '"+$("#filtro2 a")[0].text.trim()+"'"),sublayers[0].set({sql:b}),toggleFiltros(a)}function busquedaKeyword(a){$("#buscadorEscuelas");if(""!=$("#buscadorEscuelas").val()){$("#listado").css("display","inline"),a=a.toLowerCase();var b="SELECT * FROM escuelas_2015 WHERE LOWER(nombre) LIKE '%"+a+"%'";sql.execute(b).done(function(a){$("#resultados").text("");for(var b=0;b<a.total_rows;b++)$("#resultados").append("<li><a href='#' id='ESC"+a.rows[b].cartodb_id+"' onclick='verEscuela(this.id)'>"+a.rows[b].nombre.toLowerCase()+"</a></li>")}).error(function(a){console.log("SQL ERR:",a)})}else $("#listado").css("display","none")}function verEscuela(a){$("#listado").css("display","none"),$("#buscadorEscuelas").val(""),verDetallesEscuela(a)}function openInfowindow(a,b,c){a.trigger("featureClick",null,b,null,{cartodb_id:c},0),dibujaGraficoInfowindow($("#mismacomuna").text())}function verDetallesEscuela(a){var b=a.split("ESC"),c="SELECT * FROM escuelas_2015 WHERE cartodb_id = "+b[1];resetFiltros(),capas.setZoom(16),$.getJSON("http://gcba.cartodb.com/api/v2/sql/?q="+c,function(a){setTimeout(function(){capas.setCenter([a.rows[0].lat,a.rows[0].lng]),openInfowindow(capaInfowindows,[a.rows[0].lat,a.rows[0].lng],a.rows[0].cartodb_id,0)},1500)})}function resetFiltros(){sublayers[0].set({sql:"SELECT * FROM escuelas_2015"}),$("#filtro1 li a").parents(".btn-group").find(".dropdown-toggle").html('Ver todos <span class="caret"></span>'),$("#filtro2 li a").parents(".btn-group").find(".dropdown-toggle").html('Ver todas <span class="caret"></span>')}function dibujaGraficoInfowindow(a){var b=parseInt(a.split("%")[0]),c=100-b;if(b>=0&&100>=b){var d=100,e=100,f=e/2,g=20,h=["#999999","#eeeeee"];c>b&&(b=-1*b,c=-1*c);var i=[{value:b},{value:c}],j=d3.select("#graficoMigracion").append("svg:svg").data([i]).attr("width",d).attr("height",e).append("svg:g").attr("transform","translate("+f+","+f+")"),k=d3.layout.pie().value(function(a){return a.value}),l=d3.svg.arc().innerRadius(f-g).outerRadius(f),m=j.selectAll("g").data(k).enter().append("svg:g");m.append("svg:path").attr("fill",function(a,b){return h[b]}).attr("d",function(a){return l(a)}),d3.select("g").append("text").attr("transform",function(a){return"translate("+l.centroid(a)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(){return 0>b&&(b=-1*b),b+" %"})}}var sublayers=[],capas,capaInfowindows;window.onload=loadMap,$("#filtro1 li a").click(function(){var a=$(this).text();$(this).parents(".btn-group").find(".dropdown-toggle").html(a+' <span class="caret"></span>'),filtro(this)}),$("#filtro2 li a").click(function(){var a=$(this).text();$(this).parents(".btn-group").find(".dropdown-toggle").html(a+' <span class="caret"></span>'),filtro(this)}),$("#buscadorEscuelas").keyup(function(){busquedaKeyword($("#buscadorEscuelas").val())});var sql=cartodb.SQL({user:"gcba"});