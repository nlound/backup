function endall(a,b){var c=0;a.each(function(){++c}).each("end",function(){--c||b.apply(this,arguments)})}function showOneCirculito(){d3.selectAll("circle").attr("class",currentSeccion+" general"),$(".circulo").hide(),grupoCirculoMedio.style("display","block"),circuloMedio.attr("cx",posxMedio).attr("cy",posyMedio),circuloMedio.transition().duration(500).attr("r",circulo.radioGrande)}function hideOneCirculitoYJuntar(){circuloMedio.transition().duration(500).attr("r",circulo.radio).call(endall,function(){juntarCirculitos()})}function juntarCirculitos(){d3.selectAll("rect").transition().attr("x",function(a,b){return circulo.posx+(circulo.margin+circulo.radio)*(b%grillaSvg.columnasGeneral+1)-circulo.radio-(circulo.margin-circulo.radio)/2}).attr("y",function(a,b){return circulo.posy+(circulo.margin+circulo.radio)*(Math.floor(b/grillaSvg.columnasGeneral)+1)-circulo.radio-(circulo.margin-circulo.radio)/2}),d3.selectAll("circle").transition(500).ease("quad-in").attr("cx",function(a,b){return circulo.posx+(circulo.margin+circulo.radio)*(b%grillaSvg.columnasGeneral+1)}).transition(500).ease("quad-out").attr("cy",function(a,b){return circulo.posy+(circulo.margin+circulo.radio)*(Math.floor(b/grillaSvg.columnasGeneral)+1)}),d3.selectAll("circle").attr("class",currentSeccion+" general").attr("nivel","general")}function calcularPosxNivel(a,b){return a+((b+1)*(circulo.margin+circulo.radio)-(circulo.margin+circulo.radio)*grillaSvg.columnasPorNivel*Math.floor(b/grillaSvg.columnasPorNivel))}function calcularPosicionXComuna(a){var b=niveles[0].x0;return b+((a+1)*(circulo.margin+circulo.radio)-(circulo.margin+circulo.radio)*grillaSvg.columnasPorNivel*Math.floor(a/grillaSvg.columnasPorNivel))}function calcularPosyNivel(a){return grillaSvg.alto-grillaSvg.labelSpace-Math.floor(a/grillaSvg.columnasPorNivel)*(circulo.margin+circulo.radio)}function calcularNivel(a){for(var b=0,c=niveles[b].total;a>=c;)b++,c+=niveles[b].total;return b}function calcularNuevaPosicion(a,b){var c,d=calcularNivel(b),e=0;if(d>0)for(var f=d;f>0;)e+=niveles[f-1].total,f--;return currentIndex=b-e,"x"==a?(x0=niveles[d].x0,c=calcularPosxNivel(x0,currentIndex)):"y"==a?c=calcularPosyNivel(currentIndex):console.log("Hubo un error con el calculo de posiciones de los ejes X e Y"),c}function separarCirculitos(){var a=0,b=(niveles[a].total,0);d3.selectAll("circle").transition(1e3).delay(function(a,b){return.5*b}).ease("quad").attr("cx",function(a,b){return calcularNuevaPosicion("x",b)}).attr("cy",function(a,c){return b=0,calcularNuevaPosicion("y",c)}).call(endall,function(){d3.selectAll("rect").attr("x",function(){var a=$(this).parent().children("circle").attr("cx");return a-circulo.radio-(circulo.margin-circulo.radio)/2}).attr("y",function(){var a=$(this).parent().children("circle").attr("cy");return a-circulo.radio-(circulo.margin-circulo.radio)/2}),d3.selectAll("circle").attr("class",function(a,b){return currentSeccion+" nivel"+calcularNivel(b)+" general"}).attr("nivel",function(a,b){return calcularNivel(b)})})}function agregarNivelActivo(){var a=$("#dropdown-nivel select option:selected").val(),b=$("circle.nivel_activo");if(0!=b.length){var c=$("circle.nivel_activo").attr("class").replace(new RegExp("(\\s|^)nivel_activo(\\s|$)","g"),"$2");d3.selectAll("circle."+c.split(" ").join(".")+".nivel_activo").attr("class",c)}var d=$("g.labels text.nivel_activo");if(0!=d.length){var c=$("g.labels text.nivel_activo").attr("class").replace(new RegExp("(\\s|^)nivel_activo(\\s|$)","g"),"$2");d3.selectAll("g.labels text."+c.split(" ").join(".")+".nivel_activo").attr("class",c)}var e=$("g.info text.nivel_activo");if(0!=e.length){var c=$("g.info text.nivel_activo").attr("class").replace(new RegExp("(\\s|^)nivel_activo(\\s|$)","g"),"$2");d3.selectAll("g.info text."+c.split(" ").join(".")+".nivel_activo").attr("class",c)}var f=$("circle[nivel='"+a+"']"),g=f.attr("class");d3.selectAll(f).attr("class",g+" nivel_activo");var h=$("g.labels text[nivel='"+a+"']"),g=h.attr("class");d3.selectAll(h).attr("class",g+" nivel_activo");var i=$("g.info text[nivel='"+a+"']"),g=i.attr("class");d3.selectAll(i).attr("class",g+" nivel_activo")}function mostrarMapaComunas(){if(0==$("circle.nivel_activo").length){var a=$("circle[nivel='0']");d3.selectAll(a).attr("class","comuna nivel0 general nivel_activo");var b=$("g.labels text[nivel='0']");d3.selectAll(b).attr("class","comuna nivel0 general nivel_activo")}$(".circulo").hide(),$("circle.nivel_activo").parent().show(),d3.selectAll($("circle")).attr("cx",function(a,b){return calcularNuevaPosicion("x",b)}),d3.selectAll("rect").attr("x",function(){var a=$(this).parent().children("circle").attr("cx");return a-circulo.radio-(circulo.margin-circulo.radio)/2}),d3.selectAll("circle.nivel_activo").transition().attr("cx",function(a,b){return calcularPosicionXComuna(b)}).call(endall,function(){d3.selectAll("rect").attr("x",function(){var a=$(this).parent().children("circle").attr("cx");return a-circulo.radio-(circulo.margin-circulo.radio)/2})}),d3.select("#mapaCABA svg").transition().duration(400).attr("x",350);{var c=$("circle.nivel_activo").attr("nivel");$("#dropdown-nivel option[value='"+c+"']").attr("selected","selected")}nivelActivo=$("#dropdown-nivel :selected").text().toLowerCase(),$("g.labels").show();var d=$("g.labels text[nivel='"+c+"'] tspan.nivelLink")[0];d3.select(d).style("text-decoration","none").style("font-weight","normal").on("click",function(){}),$("g.labels text[nivel='"+c+"']").show(),d3.selectAll("g.labels text[nivel='"+c+"']").attr("x",function(){return niveles[0].x0+circulo.margin}),d3.selectAll("g.labels text[nivel='"+c+"'] tspan").attr("x",function(){return niveles[0].x0+circulo.margin}),$("tspan.nivelLink").removeAttr("x"),$("g.labels text:not([nivel='"+c+"'])").hide(),$("g.descripciones").show(),$("g.descripciones text[nivel='"+c+"']").show(),$("g.descripciones text:not([nivel='"+c+"'])").hide()}function resetRadios(){if($("li > input:radio[name='filtro']").is(":checked")){var a=$("input:radio[name='filtro']:checked"),b=(a.attr("previousValue"),$(".form-group li").find("svg:has(path)"));b&&b.children().remove(),a.removeAttr("checked"),a.attr("previousValue",!1)}}function resetCambioSeccion(){function a(){circuloMedio.attr("r",circulo.radio)}function b(){$("#mapaCABA").hide(),d3.select("#mapaCABA svg").attr("x",mapaSvg.posInicialX).attr("y",mapaSvg.posInicialY)}switch(resetRadios(),$("a.arrow").hide(),$("#bajada").animate({opacity:0}),currentSeccion=$("section.active").attr("id"),d3.selectAll("circle").transition().duration(500).attr("fill",colores.neutro),"comuna"!=currentSeccion&&(b(),$("#dropdown-nivel").hide(),$("g.descripciones").hide()),"niveles"!=currentSeccion&&($("g.labels").hide(),$("#radio-grados").parent().hide()),$("g.info").hide(),currentSeccion){case"landing":$(".filtro").hide();break;case"niveles":a();break;case"comuna":a(),nivelMapaCaba="inicial",$("svg").show();break;case"mapa":$("#viz-container").hide(),$("svg").hide(),$(".filtro").hide()}}function calcularLineas(a,b){b="undefined"==typeof b?infoDetails.palabrasPorLinea:b;for(var c=a.split(" "),d=[],e=0;e<c.length;e+=b){var f=c.slice(e,e+b),g=f.join(" ");d.push(g)}return d}function generarInfoTextLanding(){var a=explicativos.secciones.landing.estadoCero;infoGroup.append("text");for(var b=calcularLineas(a.general),c=parseInt(circuloMedio.attr("cx"))+circulo.radioGrande+2*circulo.margin,d=parseInt(circuloMedio.attr("cy"))-Math.floor(b.length/2)*infoDetails.verticalMargin,e=d3.select("g.info text").text(b[0]).attr("x",c).attr("y",d).attr("class",currentSeccion+" general").attr("nivel","general"),f=1;f<b.length;f++)e.append("tspan").text(b[f]).attr("x",c).attr("y",d+infoDetails.verticalMargin*f).attr("class",currentSeccion+" general").attr("nivel","general")}function generarInfoTextGeneral(a){var b=explicativos.secciones.general[a],c=Object.keys(b);infoGroup.selectAll("g.info text").data(c).enter().append("text");for(var d=0,e=0,f=0,g=c.length-1;g>=0;g--){var h="";h="preferencia"==a?calcularLineas(b[c[g]],4):calcularLineas(b[c[g]]),e=grillaSvg.columnasGeneral*(circulo.radio+circulo.margin)+circulo.posx+circulo.radio+2*circulo.margin,d="estadoCero"==a?grillaSvg.filasGeneral*(circulo.radio+circulo.margin)/2+circulo.posy+Math.floor(h.length/2)*infoDetails.verticalMargin:grillaSvg.filasGeneral*(circulo.radio+circulo.margin)+circulo.posy-f*infoDetails.verticalMargin;var i=d3.selectAll("g.info text").filter(function(a,b){return b==g});i.text(h[0]).attr("x",e).attr("y",d-(h.length-1)*infoDetails.verticalMargin).attr("class",currentSeccion+" "+c[g]).attr("nivel","general").on("mouseover",function(){var a=$(this).attr("class").split(" ").slice(0,2);d3.selectAll($("circle:not(."+a.join(".")+")")).style("opacity",.2),d3.selectAll($("g.labels text:not(."+a.join(".")+")")).style("opacity",.2),d3.selectAll($("g.info text:not(."+a.join(".")+")")).style("opacity",.2)}).on("mouseout",function(){d3.selectAll("circle").style("opacity",1),d3.selectAll("text").style("opacity",1)}),f++;for(var j=0,k=h.length-1;k>=1;k--)j=d-(h.length-k-1)*infoDetails.verticalMargin,i.append("tspan").text(h[k]).attr("x",e).attr("y",j).attr("class",currentSeccion+" "+c[g]).attr("nivel","general"),f++}}function generarInfoTextNiveles(a){var b=explicativos.secciones.niveles,c=Object.keys(b),d=0,e=0;if("estadoCero"==a){var f=labelsGroup.selectAll("text");0!=f.length&&labelsGroup.selectAll("text").remove(),labelsGroup.selectAll("text").data(c).enter().append("text");for(var g="",h=0;h<c.length;h++){g=b[c[h]][a].general;var i=calcularLineas(g),j=i[i.length-1].split(" "),k=j[j.length-1];d=coordenadasNiveles[h]+circulo.margin,e=grillaSvg.alto-grillaSvg.labelSpace+2*infoDetails.verticalMargin;var l=d3.selectAll("g.labels text").filter(function(a,b){return b==h});l.text(i[0]).attr("x",d).attr("y",e).attr("class",currentSeccion+" "+c[h]+" general").attr("nivel",h).on("mouseover",function(){var a=$(this).attr("class").split(" ").slice(0,2);d3.selectAll($("circle:not(."+a.join(".")+")")).style("opacity",.2),d3.selectAll($("g.labels text:not(."+a.join(".")+")")).style("opacity",.2),d3.selectAll($("g.info text:not(."+a.join(".")+")")).style("opacity",.2)}).on("mouseout",function(){d3.selectAll("circle").style("opacity",1),d3.selectAll("text").style("opacity",1)});for(var m=0,n="",o=1;o<i.length;o++){m=e+infoDetails.verticalMargin*o,n=i[o],o==i.length-1&&(n=i[o].split(" ").slice(0,2).join(" ")+" ");var p=l.append("tspan").text(n).attr("x",d).attr("y",m).attr("class",currentSeccion+" "+c[h]+" general animated fadeIn").attr("nivel",h);o==i.length-1&&p.append("tspan").text(k).attr("font-weight","bold").attr("text-decoration","underline").attr("class","nivelLink "+k).on("click",function(){$(".main").moveDown();var a=$(this).parent().attr("nivel"),b=$("circle[nivel='"+a+"']"),c=b.attr("class");d3.selectAll(b).attr("class",c+" nivel_activo")})}}}else{for(var q=[],r=[],h=0;h<c.length;h++){var s=b[c[h]][a],t=Object.keys(s);r.push(t);for(var o=0;o<t.length;o++)q.push(t[o])}infoGroup.selectAll("g.info text").data(q).enter().append("text");for(var u=grillaSvg.columnasPorNivel*(circulo.margin+2*circulo.radio),h=0;h<c.length;h++)for(var s=b[c[h]][a],t=Object.keys(s),v=0,o=0;o<t.length;o++){var i=[];i="procedencia"==a?calcularLineas(s[t[o]],2):"preferencia"==a?calcularLineas(s[t[o]],4):calcularLineas(s[t[o]]),d=coordenadasNiveles[h]+u,e=grillaSvg.alto-grillaSvg.labelSpace-v*infoDetails.verticalMargin;var l=d3.selectAll("g.info text").filter(function(a,b){for(var c=0,d=0;h>c;)d+=r[c].length,c++;return b==d+o});l.text(i[0]).attr("x",d).attr("y",e-(i.length-1)*infoDetails.verticalMargin).attr("class",function(){return currentSeccion+" "+c[h]+" "+t[o]}).attr("nivel",h).on("mouseover",function(){var a=$(this).attr("class").split(" ");d3.selectAll($("circle:not(."+a.join(".")+")")).style("opacity",.2),d3.selectAll($("g.labels text:not(."+a.join(".")+")")).style("opacity",.2),d3.selectAll($("g.info text:not(."+a.join(".")+")")).style("opacity",.2)}).on("mouseout",function(){d3.selectAll("circle").style("opacity",1),d3.selectAll("text").style("opacity",1)}),v++;for(var m=0,w=i.length-1;w>=1;w--)m=e-(i.length-w-1)*infoDetails.verticalMargin,l.append("tspan").text(i[w]).attr("x",d).attr("y",m).attr("class",currentSeccion+" "+c[h]+" "+t[o]).attr("nivel",h),v++}}}function generarInfoTextComuna(a){var b=$("circle.nivel_activo").attr("nivel");if("estadoCero"==a){generarInfoTextNiveles(a);var c=$("g.labels text[nivel='"+b+"'] tspan.nivelLink")[0];d3.select(c).style("text-decoration","none").style("font-weight","normal").on("click",function(){}),$("g.labels text[nivel='"+b+"']").show(),d3.selectAll("g.labels text[nivel='"+b+"']").attr("x",function(){return niveles[0].x0+circulo.margin}),d3.selectAll("g.labels text[nivel='"+b+"'] tspan").attr("x",function(){return niveles[0].x0+circulo.margin}),$("tspan.nivelLink").removeAttr("x"),$("g.labels text:not([nivel='"+b+"'])").hide()}else if("descripcion"==a){{var d=explicativos.secciones.comuna,e=Object.keys(d),f=0,g=0;descripcionesGroup.selectAll("text")}0!=descripcionesGroup.length&&descripcionesGroup.selectAll("text").remove(),descripcionesGroup.selectAll("text").data(e).enter().append("text");for(var h="",i=0;i<e.length;i++){h=d[e[i]][a];{var j=calcularLineas(h,5),k=j[j.length-1].split(" ");k[k.length-1]}f=niveles[2].x0,g=grillaSvg.alto/2-Math.floor(j.length/2)*infoDetails.verticalMargin;var l=d3.selectAll("g.descripciones text").filter(function(a,b){return b==i});l.text(j[0]).attr("x",f).attr("y",g).attr("class",currentSeccion+" "+e[i]+" descripcion animated fadeIn").attr("nivel",i);for(var m=0,n="",o=1;o<j.length;o++){m=g+infoDetails.verticalMargin*o,n=j[o];{l.append("tspan").text(n).attr("x",f).attr("y",m).attr("class",currentSeccion+" "+e[i]+" descripcion animated fadeIn").attr("nivel",i)}}}}else generarInfoTextNiveles(a),d3.selectAll("g.labels text[nivel='"+b+"']").attr("class",function(){return d3.select(this).attr("class")+" nivel_activo"}),d3.selectAll("g.info text[nivel='"+b+"']").attr("class",function(){return d3.select(this).attr("class")+" nivel_activo"}),$("g.info text[nivel='"+b+"']").show(),d3.selectAll("g.info text[nivel='"+b+"']").attr("x",function(){return niveles[0].x0+circulo.margin+grillaSvg.columnasPorNivel*(circulo.margin+circulo.radio)}),d3.selectAll("g.info text[nivel='"+b+"'] tspan").attr("x",function(){return niveles[0].x0+circulo.margin+grillaSvg.columnasPorNivel*(circulo.margin+circulo.radio)}),$("g.info text:not([nivel='"+b+"'])").hide()}function generarInfoText(a){switch($("g.info").show(),a="undefined"==typeof a?"estadoCero":a,infoGroup.selectAll("text").remove(),currentSeccion){case"landing":generarInfoTextLanding();break;case"general":generarInfoTextGeneral(a);break;case"niveles":generarInfoTextNiveles(a);break;case"comuna":generarInfoTextComuna(a)}}var currentSeccion=$("section.active").attr("id");$(".main").onepage_scroll({sectionContainer:"section",easing:"ease",animationTime:300,pagination:!0,updateURL:!1,beforeMove:function(){resetCambioSeccion()},afterMove:function(){switch(currentSeccion=$("section.active").attr("id"),$("section.active").removeClass("active"),$("section#"+currentSeccion).addClass("active"),$("#bajada").text(contenido.secciones[currentSeccion].bajada).fadeTo("fast",1),$("a.arrow").fadeIn(),$(".prev-section span.referencia").text(contenido.secciones[currentSeccion].anteriorSeccion).fadeIn(),$(".next-section span.referencia").text(contenido.secciones[currentSeccion].proximaSeccion).fadeIn(),currentSeccion){case"landing":showOneCirculito(),$(".prev-section").hide();break;case"general":$(".circulo").show(),$(".filtro").show(),$(".prev-section").show(),circuloMedio.attr("r")==circulo.radio?juntarCirculitos():hideOneCirculitoYJuntar();break;case"niveles":$(".filtro").show(),$(".circulo").show(),$("g.labels").show(),$("g.labels text").show(),$(".prev-section").show(),$("#radio-grados").parent().show(),separarCirculitos();break;case"comuna":$("#mapaCABA").show(),$(".filtro").show(),$("#viz-container").show(),$("#dropdown-nivel").show(),$(".prev-section").show(),generarInfoTextComuna("descripcion"),mostrarMapaComunas(),queue().defer(d3.json,"data/comunas.json").defer(d3.json,"data/data.json").await(ready);break;case"mapa":}generarInfoText()},loop:!1,keyboard:!0,responsiveFallback:!1,direction:"vertical"}),$(".next-section").click(function(){$(".main").moveDown()}),$(".prev-section").click(function(){$(".main").moveUp()});for(var svgGeneral=d3.select("svg#viz"),grilla=svgGeneral.append("g").attr("class","contenedor"),mapaComunas=svgGeneral.append("g").attr("id","mapaCABA"),json=function(){var a=null;return $.ajax({async:!1,global:!1,url:"data/data.json",dataType:"json",success:function(b){a=b}}),a}(),generalFemenino=Math.round(json.general.genero.femenino*totalCirculos/100),generalMasculino=Math.round(json.general.genero.masculino*totalCirculos/100),generalCABA=Math.round(json.general.procedencia.caba*totalCirculos/100),generalProvincia=Math.round(json.general.procedencia.provincia*totalCirculos/100),jsonNiveles=json.niveles,cantidadNiveles=Object.keys(jsonNiveles).length,niveles=[],i=0;cantidadNiveles>i;i++){var nivelActual=jsonNiveles[Object.keys(jsonNiveles)[i]],cantidadTotal=Math.round(nivelActual.total*totalCirculos/100),cantidadFemenino=Math.round(nivelActual.genero.femenino*cantidadTotal/100),cantidadMasculino=Math.round(nivelActual.genero.masculino*cantidadTotal/100),cantidadCABA=Math.round(nivelActual.procedencia.caba*cantidadTotal/100),cantidadProvincia=Math.round(nivelActual.procedencia.provincia*cantidadTotal/100),newNivel={x0:coordenadasNiveles[i],total:cantidadTotal,genero:{femenino:cantidadFemenino,masculino:cantidadMasculino},procedencia:{caba:cantidadCABA,provincia:cantidadProvincia}};niveles.push(newNivel)}var explicativos=function(){var a=null;return $.ajax({async:!1,global:!1,url:"data/explicativos.json",dataType:"json",success:function(b){a=b}}),a}(),contenido=function(){var a=null;return $.ajax({async:!1,global:!1,url:"data/contenido.json",dataType:"json",success:function(b){a=b}}),a}();for(i=0;i<grillaSvg.filasGeneral;i++)for(j=0;j<grillaSvg.columnasGeneral;j++){var grupo=grilla.append("g").attr("class","circulo animated fadeIn");grupo.append("circle").attr("fill",colores.neutro).attr("r",circulo.radio).attr("class",currentSeccion),grupo.append("rect").attr("width",2*circulo.radio+circulo.margin-circulo.radio).attr("height",2*circulo.radio+circulo.margin-circulo.radio).attr("fill","transparent").on("mouseover",function(){var a=$(this).parent().children("circle"),b=a.attr("class");d3.selectAll($("circle:not(."+b.split(" ").join(".")+")")).style("opacity",.2),d3.selectAll($("g.labels text:not(."+b.split(" ").join(".")+")")).style("opacity",.2),d3.selectAll($("g.info text:not(."+b.split(" ").join(".")+")")).style("opacity",.2)}).on("mouseout",function(){d3.selectAll("circle").style("opacity",1),d3.selectAll("text").style("opacity",1)})}var middleIndex=Math.floor(totalCirculos/2)-1,grupoCirculoMedio=d3.selectAll("g.circulo").filter(function(a,b){return b==middleIndex}),circuloMedio=d3.selectAll("circle").filter(function(a,b){return b==middleIndex}),posxMedio=circulo.posx+(circulo.margin+circulo.radio)*(middleIndex%grillaSvg.columnasGeneral+1),posyMedio=circulo.posy+(circulo.margin+circulo.radio)*(Math.floor(middleIndex/grillaSvg.columnasGeneral)+1);juntarCirculitos(),showOneCirculito();var infoGroup=svgGeneral.append("g").attr("class","info animated fadeInUp"),labelsGroup=svgGeneral.append("g").attr("class","labels animated fadeInDown"),descripcionesGroup=svgGeneral.append("g").attr("class","descripciones animated fadeInDown");generarInfoText(),$("#dropdown-nivel select").change(function(){resetRadios(),d3.selectAll("input[type=radio]").property("checked",!1),d3.selectAll("circle").attr("fill",colores.neutro).attr("class",function(){return currentSeccion+" nivel"+d3.select(this).attr("nivel")+" general"}),$("g.info").hide(),agregarNivelActivo(),mostrarMapaComunas(),queue().defer(d3.json,"data/comunas.json").defer(d3.json,"data/data.json").await(ready)});